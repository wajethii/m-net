<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High-Speed Internet Coverage | Thika Areas</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map {
            height: 70vh;
            z-index: 10;
            border-radius: 0.75rem;
        }
        .leaflet-popup-content-wrapper {
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        .location-marker {
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header Section -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-800 mb-3">Our Fiber Network Coverage</h1>
            <p class="text-gray-600 max-w-2xl mx-auto">Check if our high-speed internet is available at your location in Thika</p>
        </header>

        <!-- Search Card -->
        <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden mb-8 transition-all duration-300 hover:shadow-xl">
            <div class="p-5 flex flex-col md:flex-row gap-2">
                <div class="flex-grow relative">
                    <input 
                        type="text" 
                        id="address-input" 
                        placeholder="e.g. Kiganjo Market, Makongeni Phase 3" 
                        class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                    <div id="suggestions" class="hidden absolute z-20 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg"></div>
                </div>
                <button 
                    id="search-btn"
                    onclick="searchAddress()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition duration-200 flex items-center justify-center gap-2"
                >
                    <span id="btn-text">Check Coverage</span>
                    <svg id="loading-icon" class="hidden loading-spinner w-5 h-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Map Card -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div id="map"></div>
            <div class="p-4 bg-gray-50 border-t border-gray-200">
                <div class="flex flex-wrap gap-4 justify-center">
                    <div class="flex items-center bg-blue-50 px-3 py-1 rounded-full">
                        <div class="w-3 h-3 bg-blue-600 rounded-full mr-2"></div>
                        <span class="text-sm font-medium text-blue-800">Covered Areas</span>
                    </div>
                    <div class="flex items-center bg-green-50 px-3 py-1 rounded-full">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                        <span class="text-sm font-medium text-green-800">Your Location</span>
                    </div>
                    <div class="flex items-center bg-yellow-50 px-3 py-1 rounded-full">
                        <div class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></div>
                        <span class="text-sm font-medium text-yellow-800">Coming Soon</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coverage Areas List -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-600">
                <h3 class="font-bold text-lg text-gray-800 mb-2">Kiganjo</h3>
                <p class="text-gray-600 text-sm">Full fiber coverage</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-600">
                <h3 class="font-bold text-lg text-gray-800 mb-2">Makongeni</h3>
                <p class="text-gray-600 text-sm">Full fiber coverage</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-600">
                <h3 class="font-bold text-lg text-gray-800 mb-2">Kisii Estate</h3>
                <p class="text-gray-600 text-sm">Full fiber coverage</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-600">
                <h3 class="font-bold text-lg text-gray-800 mb-2">Landless</h3>
                <p class="text-gray-600 text-sm">Full fiber coverage</p>
            </div>
        </div>

        <!-- CTA Section -->
        <div class="mt-10 text-center bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl p-8 text-white">
            <h2 class="text-2xl font-bold mb-3">Ready to experience blazing-fast internet?</h2>
            <p class="mb-6 max-w-2xl mx-auto">Our fiber network delivers speeds up to 1Gbps with 99.9% uptime</p>
            <button class="bg-white text-blue-800 font-bold px-8 py-3 rounded-lg hover:bg-gray-100 transition duration-200">
                Sign Up Now
            </button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet PIP for coverage check -->
    <script src="https://unpkg.com/leaflet-pip@1.1.0/leaflet-pip.js"></script>
    
    <script>
        // Initialize map with better tile layer for clarity
        const map = L.map('map', {
            zoomControl: false,
            preferCanvas: true
        }).setView([-1.039, 37.08], 14);

        // Add high-contrast map tiles (CartoDB Positron)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // Add zoom control with better position
        L.control.zoom({
            position: 'topright'
        }).addTo(map);

        // Define precise coverage areas (adjust coordinates as needed)
        const coverageAreas = {
            "Kiganjo": L.polygon([
                [-1.028, 37.065],  // NW
                [-1.028, 37.078],  // NE
                [-1.042, 37.078],  // SE
                [-1.042, 37.065]   // SW
            ], {color: '#2563eb', weight: 2, fillOpacity: 0.15}),
            
            "Makongeni": L.polygon([
                [-1.035, 37.075],
                [-1.035, 37.088],
                [-1.050, 37.088],
                [-1.050, 37.075]
            ], {color: '#2563eb', weight: 2, fillOpacity: 0.15}),
            
            "Kisii Estate": L.polygon([
                [-1.032, 37.082],
                [-1.032, 37.095],
                [-1.045, 37.095],
                [-1.045, 37.082]
            ], {color: '#2563eb', weight: 2, fillOpacity: 0.15}),
            
            "Landless": L.polygon([
                [-1.025, 37.085],
                [-1.025, 37.098],
                [-1.038, 37.098],
                [-1.038, 37.085]
            ], {color: '#2563eb', weight: 2, fillOpacity: 0.15})
        };

        // Add coverage areas to map with enhanced styling
        Object.entries(coverageAreas).forEach(([name, area]) => {
            area.addTo(map)
                .bindPopup(`<div class="font-bold text-blue-800">${name}</div><div class="text-green-600">✓ Full Coverage</div>`);
            
            // Add area label
            const center = area.getBounds().getCenter();
            L.marker(center, {
                icon: L.divIcon({
                    className: 'area-label',
                    html: `<div class="text-blue-800 font-bold bg-white bg-opacity-80 px-2 py-1 rounded">${name}</div>`,
                    iconSize: [100, 20]
                }),
                zIndexOffset: -1000,
                interactive: false
            }).addTo(map);
        });

        // Address search with debouncing
        let searchTimeout;
        document.getElementById('address-input').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(fetchSuggestions, 300);
        });

        async function fetchSuggestions() {
            const query = document.getElementById('address-input').value.trim();
            if (query.length < 3) {
                document.getElementById('suggestions').classList.add('hidden');
                return;
            }

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', Thika, Kenya')}&limit=5`);
                const data = await response.json();
                
                const suggestions = document.getElementById('suggestions');
                suggestions.innerHTML = '';
                
                if (data.length === 0) {
                    suggestions.innerHTML = '<div class="p-3 text-gray-500">No suggestions found</div>';
                } else {
                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-0';
                        div.textContent = item.display_name;
                        div.onclick = () => {
                            document.getElementById('address-input').value = item.display_name;
                            suggestions.classList.add('hidden');
                            searchAddress();
                        };
                        suggestions.appendChild(div);
                    });
                }
                
                suggestions.classList.remove('hidden');
            } catch (error) {
                console.error("Suggestions error:", error);
            }
        }

        // Click outside to close suggestions
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#address-input') && !e.target.closest('#suggestions')) {
                document.getElementById('suggestions').classList.add('hidden');
            }
        });

        // Improved address lookup
        async function searchAddress() {
            const address = document.getElementById('address-input').value.trim();
            if (!address) {
                showAlert("Please enter an address", "error");
                return;
            }

            // UI Loading state
            const btn = document.getElementById('search-btn');
            const btnText = document.getElementById('btn-text');
            const loadingIcon = document.getElementById('loading-icon');
            
            btn.disabled = true;
            btnText.textContent = "Searching...";
            loadingIcon.classList.remove('hidden');

            try {
                // Clear previous markers
                if (window.currentMarker) {
                    map.removeLayer(window.currentMarker);
                }

                // Geocode address
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Thika, Kenya')}&limit=1`);
                const data = await response.json();

                if (data.length === 0) {
                    showAlert("Address not found. Try being more specific (e.g. include a street name).", "error");
                    return;
                }

                const lat = parseFloat(data[0].lat);
                const lon = parseFloat(data[0].lon);
                const displayName = data[0].display_name;

                // Add marker with custom icon
                window.currentMarker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'location-marker',
                        html: `
                            <div class="relative">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 text-green-600">
                                    <path fill-rule="evenodd" d="M11.54 22.351l.07.04.028.016a.76.76 0 00.723 0l.028-.015.071-.041a16.975 16.975 0 001.144-.742 19.58 19.58 0 002.683-2.282c1.944-1.99 3.963-4.98 3.963-8.827a8.25 8.25 0 00-16.5 0c0 3.846 2.02 6.837 3.963 8.827a19.58 19.58 0 002.682 2.282 16.975 16.975 0 001.145.742zM12 13.5a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                                </svg>
                                <div class="absolute -bottom-1 left-1/2 transform -translate-x-1/2 w-2 h-2 bg-green-600 rounded-full animate-pulse"></div>
                            </div>
                        `,
                        iconSize: [32, 32],
                        iconAnchor: [16, 32]
                    }),
                    zIndexOffset: 1000
                }).addTo(map)
                .bindPopup(`
                    <div class="text-sm">
                        <div class="font-bold mb-1">Your Location</div>
                        <div class="text-gray-700">${displayName}</div>
                    </div>
                `)
                .openPopup();

                // Zoom to location with padding
                map.flyTo([lat, lon], 16, {
                    duration: 1,
                    easeLinearity: 0.25,
                    paddingTopLeft: [0, 50]
                });

                // Check coverage
                let isCovered = false;
                for (const area of Object.values(coverageAreas)) {
                    if (leafletPip.pointInLayer([lon, lat], area)) {
                        isCovered = true;
                        break;
                    }
                }

                // Show result
                setTimeout(() => {
                    showAlert(
                        isCovered 
                            ? "✅ Excellent! We cover your location with our fiber network." 
                            : "❌ Not covered yet. We're expanding daily - contact us for updates!",
                        isCovered ? "success" : "warning"
                    );
                }, 800);

            } catch (error) {
                console.error("Geocoding error:", error);
                showAlert("Error checking address. Please try again.", "error");
            } finally {
                // Reset UI
                btn.disabled = false;
                btnText.textContent = "Check Coverage";
                loadingIcon.classList.add('hidden');
            }
        }

        // Show alert toast
        function showAlert(message, type) {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium ${
                type === 'error' ? 'bg-red-500' : 
                type === 'success' ? 'bg-green-500' : 'bg-yellow-500'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Allow Enter key to trigger search
        document.getElementById('address-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchAddress();
            }
        });

        // Initial map bounds to show all coverage areas
        const bounds = L.latLngBounds(
            Object.values(coverageAreas).map(area => area.getBounds())
        );
        map.fitBounds(bounds, { padding: [50, 50] });
    </script>
</body>
</html>